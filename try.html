<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Smart Sheet Translator</title>
  
  <!-- Bootstrap 5 CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  
  <!-- Bootstrap Icons -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
  
  <style>
    /* Dark mode friendly styling */
    body {
      background-color: #1a1a1a;
      color: #e0e0e0;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      padding: 15px;
      min-height: 100vh;
    }
    
    .container {
      max-width: 800px;
      margin: 0 auto;
    }
    
    /* Card Styling */
    .card {
      background-color: #2d2d2d;
      border: 1px solid #404040;
      border-radius: 10px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
      margin-bottom: 20px;
    }
    
    .card-header {
      background-color: #3d3d3d;
      border-bottom: 1px solid #404040;
      color: #ffffff;
      font-weight: 600;
    }
    
    .card-body {
      padding: 1.5rem;
    }
    
    /* Form Elements */
    .form-label {
      color: #b0b0b0;
      font-weight: 500;
      margin-bottom: 0.5rem;
    }
    
    .form-select,
    .form-control {
      background-color: #3d3d3d;
      border: 1px solid #505050;
      color: #e0e0e0;
    }
    
    .form-select:focus,
    .form-control:focus {
      background-color: #454545;
      border-color: #0d6efd;
      color: #e0e0e0;
      box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25);
    }
    
    .form-select option {
      background-color: #2d2d2d;
      color: #e0e0e0;
    }
    
    .form-check-input {
      background-color: #3d3d3d;
      border-color: #505050;
    }
    
    .form-check-input:checked {
      background-color: #0d6efd;
      border-color: #0d6efd;
    }
    
    .form-check-label {
      color: #e0e0e0;
    }
    
    /* Buttons */
    .btn-primary {
      background-color: #0d6efd;
      border-color: #0d6efd;
      font-weight: 500;
    }
    
    .btn-primary:hover {
      background-color: #0b5ed7;
      border-color: #0a58ca;
    }
    
    .btn-primary:disabled {
      background-color: #4a4a4a;
      border-color: #4a4a4a;
      opacity: 0.6;
    }
    
    .btn-warning {
      background-color: #ffc107;
      border-color: #ffc107;
      color: #000;
      font-weight: 500;
    }
    
    .btn-warning:hover {
      background-color: #e0a800;
      border-color: #d39e00;
      color: #000;
    }
    
    .btn-secondary {
      background-color: #6c757d;
      border-color: #6c757d;
    }
    
    .btn-secondary:hover {
      background-color: #5c636a;
      border-color: #565e64;
    }
    
    /* Progress Bar */
    .progress {
      background-color: #3d3d3d;
      border-radius: 10px;
      height: 25px;
      margin-top: 10px;
    }
    
    .progress-bar {
      background-color: #0d6efd;
      font-size: 0.9rem;
      font-weight: 500;
    }
    
    .progress-bar-striped {
      background-image: linear-gradient(
        45deg,
        rgba(255, 255, 255, 0.15) 25%,
        transparent 25%,
        transparent 50%,
        rgba(255, 255, 255, 0.15) 50%,
        rgba(255, 255, 255, 0.15) 75%,
        transparent 75%,
        transparent
      );
      background-size: 1rem 1rem;
    }
    
    /* Toast Notifications */
    .toast-container {
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 9999;
    }
    
    .toast {
      background-color: #2d2d2d;
      border: 1px solid #404040;
      color: #e0e0e0;
      min-width: 300px;
    }
    
    .toast-header {
      background-color: #3d3d3d;
      border-bottom: 1px solid #404040;
      color: #e0e0e0;
    }
    
    .toast-success .toast-header {
      background-color: #1e4d2b;
      border-bottom-color: #2d7a3e;
    }
    
    .toast-error .toast-header {
      background-color: #5c1f1f;
      border-bottom-color: #842029;
    }
    
    .toast-body {
      color: #e0e0e0;
    }
    
    /* Summary Table */
    .table {
      color: #e0e0e0;
      margin-bottom: 0;
    }
    
    .table thead th {
      background-color: #3d3d3d;
      border-color: #505050;
      color: #b0b0b0;
      font-weight: 600;
    }
    
    .table tbody td {
      border-color: #404040;
    }
    
    .table-striped tbody tr:nth-of-type(odd) {
      background-color: #2a2a2a;
    }
    
    .table-hover tbody tr:hover {
      background-color: #353535;
      color: #ffffff;
    }
    
    /* Modal */
    .modal-content {
      background-color: #2d2d2d;
      border: 1px solid #404040;
      color: #e0e0e0;
    }
    
    .modal-header {
      border-bottom: 1px solid #404040;
    }
    
    .modal-footer {
      border-top: 1px solid #404040;
    }
    
    .modal-title {
      color: #ffffff;
    }
    
    /* Badges */
    .badge {
      font-size: 0.8rem;
      padding: 0.35em 0.65em;
    }
    
    /* Spinner */
    .spinner-border {
      width: 1.5rem;
      height: 1.5rem;
      margin-right: 10px;
    }
    
    .spinner-grow {
      width: 1rem;
      height: 1rem;
    }
    
    /* Header Icon */
    .header-icon {
      font-size: 1.5rem;
      margin-right: 10px;
    }
    
    /* Utility Classes */
    .text-muted-custom {
      color: #808080 !important;
    }
    
    .text-success-custom {
      color: #a7f3c0 !important;
    }
    
    .text-danger-custom {
      color: #f8b4b4 !important;
    }
    
    .text-warning-custom {
      color: #ffda6a !important;
    }
    
    /* Hidden by default */
    .hidden {
      display: none;
    }
    
    /* Responsive */
    @media (max-width: 576px) {
      body {
        padding: 10px;
      }
      
      .card-body {
        padding: 1rem;
      }
      
      .toast-container {
        right: 10px;
        top: 10px;
      }
      
      .toast {
        min-width: 250px;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    
    <!-- Important Notice (only shown in web app mode) -->
    <div class="card" id="webAppWarning" style="border-color: #ffc107; display: none;">
      <div class="card-header" style="background-color: #856404; border-color: #ffc107;">
        <i class="bi bi-exclamation-triangle-fill"></i> Important Setup Notice
      </div>
      <div class="card-body">
        <p><strong>‚ö†Ô∏è Running as Web App has limitations!</strong></p>
        <p>For full functionality, add this script to your Google Sheet:</p>
        <ol style="font-size: 0.9rem;">
          <li>Open your Google Sheet</li>
          <li>Go to <strong>Extensions</strong> ‚Üí <strong>Apps Script</strong></li>
          <li>Copy the code from <code>code.gs</code> and <code>try.html</code></li>
          <li>Run function <code>onOpen()</code> to add menu</li>
          <li>Use <strong>üåê Translator</strong> menu ‚Üí <strong>Open Translator</strong></li>
        </ol>
        <p class="mb-0 mt-2"><small>See <code>SETUP_INSTRUCTIONS.md</code> for detailed steps.</small></p>
      </div>
    </div>
    
    <!-- Header Card -->
    <div class="card">
      <div class="card-header">
        <h4 class="mb-0">
          <i class="bi bi-translate header-icon"></i>
          Smart Sheet Translator
        </h4>
      </div>
    </div>
    
    <!-- Translation Settings Card -->
    <div class="card">
      <div class="card-header">
        <i class="bi bi-gear-fill"></i> Translation Settings
      </div>
      <div class="card-body">
        
        <!-- Language Selection -->
        <div class="mb-3">
          <label for="targetLanguage" class="form-label">
            <i class="bi bi-globe"></i> Target Language
          </label>
          <select class="form-select" id="targetLanguage">
            <option value="en">English</option>
            <option value="ms" selected>Malay (Bahasa Melayu)</option>
            <option value="zh">Chinese (‰∏≠Êñá)</option>
            <option value="ja">Japanese (Êó•Êú¨Ë™û)</option>
            <option value="ko">Korean (ÌïúÍµ≠Ïñ¥)</option>
            <option value="es">Spanish (Espa√±ol)</option>
            <option value="fr">French (Fran√ßais)</option>
            <option value="de">German (Deutsch)</option>
            <option value="it">Italian (Italiano)</option>
            <option value="pt">Portuguese (Portugu√™s)</option>
            <option value="ru">Russian (–†—É—Å—Å–∫–∏–π)</option>
            <option value="ar">Arabic (ÿßŸÑÿπÿ±ÿ®Ÿäÿ©)</option>
            <option value="hi">Hindi (‡§π‡§ø‡§®‡•ç‡§¶‡•Ä)</option>
            <option value="th">Thai (‡πÑ‡∏ó‡∏¢)</option>
            <option value="vi">Vietnamese (Ti·∫øng Vi·ªát)</option>
            <option value="id">Indonesian (Bahasa Indonesia)</option>
            <option value="tl">Tagalog (Filipino)</option>
            <option value="custom">Custom Language Code</option>
          </select>
        </div>
        
        <!-- Custom Language Code -->
        <div class="mb-3 hidden" id="customLanguageContainer">
          <label for="customLanguageCode" class="form-label">
            <i class="bi bi-code-square"></i> Custom Language Code 
            <span class="badge bg-secondary">Optional</span>
          </label>
          <input 
            type="text" 
            class="form-control" 
            id="customLanguageCode" 
            placeholder="e.g., bn, ur, sw"
            maxlength="10">
          <small class="text-muted-custom">
            Enter ISO 639-1 (2 letters) or ISO 639-3 (3 letters) code
          </small>
        </div>
        
        <!-- Selection Mode -->
        <div class="mb-3">
          <label class="form-label">
            <i class="bi bi-cursor"></i> Translation Scope
          </label>
          <div class="form-check">
            <input 
              class="form-check-input" 
              type="radio" 
              name="selectionMode" 
              id="activeCellMode" 
              value="activeCell" 
              checked>
            <label class="form-check-label" for="activeCellMode">
              Active Cell (Single Cell)
            </label>
          </div>
          <div class="form-check">
            <input 
              class="form-check-input" 
              type="radio" 
              name="selectionMode" 
              id="selectedRangeMode" 
              value="selectedRange">
            <label class="form-check-label" for="selectedRangeMode">
              Selected Range (Multiple Cells)
            </label>
          </div>
        </div>
        
        <!-- Action Buttons -->
        <div class="d-grid gap-2">
          <button 
            type="button" 
            class="btn btn-primary btn-lg" 
            id="translateBtn"
            onclick="startTranslation()">
            <i class="bi bi-lightning-charge-fill"></i> Translate Now
          </button>
          
          <button 
            type="button" 
            class="btn btn-warning" 
            id="undoBtn"
            onclick="undoTranslation()">
            <i class="bi bi-arrow-counterclockwise"></i> Undo Last Translation
          </button>
        </div>
        
        <!-- Progress Bar -->
        <div id="progressContainer" class="hidden">
          <div class="progress mt-3">
            <div 
              id="progressBar" 
              class="progress-bar progress-bar-striped progress-bar-animated" 
              role="progressbar" 
              style="width: 100%">
              Translating...
            </div>
          </div>
        </div>
        
      </div>
    </div>
    
    <!-- Translation Summary Card -->
    <div class="card hidden" id="summaryCard">
      <div class="card-header">
        <i class="bi bi-clipboard-data"></i> Translation Summary
      </div>
      <div class="card-body">
        <div class="table-responsive">
          <table class="table table-striped table-hover">
            <tbody id="summaryTableBody">
              <!-- Summary rows will be inserted here -->
            </tbody>
          </table>
        </div>
        <div class="text-center mt-2">
          <small class="text-muted-custom">
            <i class="bi bi-info-circle"></i> Last translation details
          </small>
        </div>
      </div>
    </div>
    
    <!-- Footer Info -->
    <div class="text-center mt-3" style="color: #808080; font-size: 0.85rem;">
      <i class="bi bi-info-circle"></i> 
      Select cells in your Google Sheet, choose a language, and click Translate
    </div>
    
  </div>
  
  <!-- Toast Container -->
  <div class="toast-container"></div>
  
  <!-- Confirmation Modal -->
  <div class="modal fade" id="confirmModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">
            <i class="bi bi-exclamation-triangle-fill text-warning-custom"></i>
            Confirm Translation
          </h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <p>You are about to translate <strong id="cellCountText">0</strong> cells.</p>
          <p class="mb-0">This operation will overwrite the original content. You can undo this action later.</p>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
            Cancel
          </button>
          <button type="button" class="btn btn-primary" onclick="confirmTranslation()">
            <i class="bi bi-check-circle"></i> Proceed
          </button>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Bootstrap 5 JS Bundle -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  
  <!-- Main Application Script -->
  <script>
    /**
     * Smart Sheet Translator - Frontend JavaScript (Enhanced)
     * Handles UI interactions, confirmations, progress, and communication with Code.gs
     */
    
    // ========================================================================
    // GLOBAL VARIABLES
    // ========================================================================
    
    let confirmModalInstance = null;
    let pendingTranslation = false;
    
    // ========================================================================
    // INITIALIZATION
    // ========================================================================
    
    document.addEventListener('DOMContentLoaded', function() {
      console.log('Smart Sheet Translator loaded (Enhanced)');
      
      // Detect if running as standalone web app vs sidebar/dialog
      detectRunMode();
      
      // Initialize modal
      const confirmModalEl = document.getElementById('confirmModal');
      confirmModalInstance = new bootstrap.Modal(confirmModalEl);
      
      // Listen for language dropdown changes
      const languageSelect = document.getElementById('targetLanguage');
      languageSelect.addEventListener('change', toggleCustomLanguageInput);
      
      // Initialize UI
      toggleCustomLanguageInput();
      
      console.log('Initialization complete');
    });
    
    /**
     * Detects if running as web app vs sidebar
     */
    function detectRunMode() {
      // Check if we're in an iframe (sidebar/dialog mode)
      const isInIframe = window.self !== window.top;
      
      // Check URL - web apps typically have /exec or /dev in URL
      const isWebApp = window.location.href.includes('/exec') || 
                       window.location.href.includes('/dev') ||
                       window.location.protocol === 'https:' && !isInIframe;
      
      console.log('Run mode detection:');
      console.log('  - In iframe:', isInIframe);
      console.log('  - URL:', window.location.href);
      console.log('  - Detected as web app:', isWebApp && !isInIframe);
      
      // Show warning if running as standalone web app
      if (isWebApp && !isInIframe) {
        const warning = document.getElementById('webAppWarning');
        if (warning) {
          warning.style.display = 'block';
          console.warn('‚ö†Ô∏è Running in standalone web app mode - selection detection may not work!');
        }
      }
    }
    
    // ========================================================================
    // UI HELPER FUNCTIONS
    // ========================================================================
    
    /**
     * Shows or hides the custom language code input
     */
    function toggleCustomLanguageInput() {
      const languageSelect = document.getElementById('targetLanguage');
      const customContainer = document.getElementById('customLanguageContainer');
      
      if (languageSelect.value === 'custom') {
        customContainer.classList.remove('hidden');
      } else {
        customContainer.classList.add('hidden');
      }
    }
    
    /**
     * Shows/hides the progress bar
     */
    function setProgressVisible(visible) {
      const progressContainer = document.getElementById('progressContainer');
      if (visible) {
        progressContainer.classList.remove('hidden');
      } else {
        progressContainer.classList.add('hidden');
      }
    }
    
    /**
     * Enables or disables buttons
     */
    function setButtonsEnabled(enabled) {
      document.getElementById('translateBtn').disabled = !enabled;
      document.getElementById('undoBtn').disabled = !enabled;
    }
    
    /**
     * Shows the summary card with translation details
     */
    function showSummaryCard(summary) {
      const summaryCard = document.getElementById('summaryCard');
      const summaryTableBody = document.getElementById('summaryTableBody');
      
      // Prepare summary data
      const summaryRows = [
        { label: 'Status', value: '<span class="badge bg-success">Completed</span>' },
        { label: 'Total Cells', value: summary.totalCells || 0 },
        { label: 'Translated', value: `<span class="text-success-custom">${summary.translatedCells || 0}</span>` },
        { label: 'Skipped', value: `<span class="text-muted-custom">${summary.skippedCells || 0}</span>` },
        { label: 'Source Languages', value: (summary.sourceLangs || ['auto-detected']).join(', ') },
        { label: 'Target Languages', value: (summary.targetLangs || []).join(', ').toUpperCase() },
        { label: 'Range', value: summary.selectionInfo ? summary.selectionInfo.range : 'N/A' },
        { label: 'Timestamp', value: formatTimestamp(summary.timestamp) }
      ];
      
      // Build table rows
      let html = '';
      summaryRows.forEach(row => {
        html += `
          <tr>
            <td><strong>${row.label}</strong></td>
            <td>${row.value}</td>
          </tr>
        `;
      });
      
      summaryTableBody.innerHTML = html;
      summaryCard.classList.remove('hidden');
      
      // Scroll to summary
      summaryCard.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
    }
    
    /**
     * Hides the summary card
     */
    function hideSummaryCard() {
      document.getElementById('summaryCard').classList.add('hidden');
    }
    
    /**
     * Formats ISO timestamp to readable format
     */
    function formatTimestamp(isoString) {
      if (!isoString) return 'N/A';
      
      try {
        const date = new Date(isoString);
        return date.toLocaleString('en-US', {
          year: 'numeric',
          month: 'short',
          day: 'numeric',
          hour: '2-digit',
          minute: '2-digit',
          second: '2-digit'
        });
      } catch (e) {
        return isoString;
      }
    }
    
    // ========================================================================
    // TOAST NOTIFICATIONS
    // ========================================================================
    
    /**
     * Shows a toast notification
     */
    function showToast(message, type = 'info', duration = 5000) {
      const toastContainer = document.querySelector('.toast-container');
      const toastId = 'toast-' + Date.now();
      
      // Determine icon and title based on type
      let icon = 'bi-info-circle-fill';
      let title = 'Notification';
      let toastClass = '';
      
      if (type === 'success') {
        icon = 'bi-check-circle-fill';
        title = 'Success';
        toastClass = 'toast-success';
      } else if (type === 'error') {
        icon = 'bi-exclamation-circle-fill';
        title = 'Error';
        toastClass = 'toast-error';
      } else if (type === 'warning') {
        icon = 'bi-exclamation-triangle-fill';
        title = 'Warning';
        toastClass = 'toast-warning';
      }
      
      // Create toast HTML
      const toastHtml = `
        <div id="${toastId}" class="toast ${toastClass}" role="alert" aria-live="assertive" aria-atomic="true">
          <div class="toast-header">
            <i class="bi ${icon} me-2"></i>
            <strong class="me-auto">${title}</strong>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="toast" aria-label="Close"></button>
          </div>
          <div class="toast-body">
            ${message}
          </div>
        </div>
      `;
      
      // Insert toast
      toastContainer.insertAdjacentHTML('beforeend', toastHtml);
      
      // Initialize and show toast
      const toastElement = document.getElementById(toastId);
      const bsToast = new bootstrap.Toast(toastElement, {
        autohide: true,
        delay: duration
      });
      bsToast.show();
      
      // Remove from DOM after hidden
      toastElement.addEventListener('hidden.bs.toast', function() {
        toastElement.remove();
      });
    }
    
    // ========================================================================
    // TRANSLATION LOGIC
    // ========================================================================
    
    /**
     * Gets the selected language code
     */
    function getSelectedLanguage() {
      const languageSelect = document.getElementById('targetLanguage');
      const customLanguageCode = document.getElementById('customLanguageCode');
      
      if (languageSelect.value === 'custom') {
        const customCode = customLanguageCode.value.trim();
        if (!customCode) {
          showToast('Please enter a custom language code', 'error');
          return null;
        }
        return customCode;
      }
      
      return languageSelect.value;
    }
    
    /**
     * Gets the selection mode
     */
    function getSelectionMode() {
      const activeCellRadio = document.getElementById('activeCellMode');
      return activeCellRadio.checked ? 'activeCell' : 'selectedRange';
    }
    
    /**
     * Checks selection and shows confirmation if needed
     */
    function startTranslation() {
      console.log('Translation initiated');
      
      // Validate language selection
      const targetLanguage = getSelectedLanguage();
      if (!targetLanguage) {
        return;
      }
      
      // Hide previous summary
      hideSummaryCard();
      
      // Get selection info first
      setButtonsEnabled(false);
      
      google.script.run
        .withSuccessHandler(function(result) {
          setButtonsEnabled(true);
          
          if (!result.success) {
            showToast(result.error || 'Failed to get selection', 'error');
            return;
          }
          
          console.log('Selection info:', result);
          
          const cellCount = result.numRows * result.numColumns;
          
          // Build more detailed message
          const rangeInfo = `${result.rangeA1} (${result.numRows} rows √ó ${result.numColumns} columns)`;
          const detailMsg = `<p>You are about to translate <strong>${cellCount}</strong> cells.</p>
                            <p><strong>Range:</strong> ${rangeInfo}</p>
                            <p><strong>Sheet:</strong> ${result.sheetName}</p>
                            <p><strong>Spreadsheet:</strong> ${result.spreadsheetName}</p>
                            <p class="mb-0 mt-3">This operation will overwrite the original content. You can undo this action later.</p>`;
          
          // Show confirmation if more than 10 cells
          if (cellCount > 10) {
            document.getElementById('cellCountText').textContent = cellCount;
            // Update modal body with detailed info
            const modalBody = document.querySelector('#confirmModal .modal-body');
            modalBody.innerHTML = detailMsg;
            
            pendingTranslation = true;
            confirmModalInstance.show();
          } else {
            // Proceed directly
            executeTranslation(targetLanguage);
          }
        })
        .withFailureHandler(function(error) {
          setButtonsEnabled(true);
          showToast('Error: ' + error.message, 'error');
        })
        .getSelectedRange();
    }
    
    /**
     * Confirms and executes translation (from modal)
     */
    function confirmTranslation() {
      confirmModalInstance.hide();
      
      if (pendingTranslation) {
        const targetLanguage = getSelectedLanguage();
        if (targetLanguage) {
          executeTranslation(targetLanguage);
        }
        pendingTranslation = false;
      }
    }
    
    /**
     * Executes the actual translation
     */
    function executeTranslation(targetLanguage) {
      console.log('Executing translation:', targetLanguage);
      
      // Update UI
      setButtonsEnabled(false);
      setProgressVisible(true);
      showToast('Translation in progress...', 'info', 3000);
      
      // First, get the current selection info to pass to translation
      google.script.run
        .withSuccessHandler(function(rangeInfo) {
          console.log('Range info received:', rangeInfo);
          
          if (!rangeInfo.success) {
            setProgressVisible(false);
            setButtonsEnabled(true);
            showToast('Failed to get range: ' + rangeInfo.error, 'error');
            return;
          }
          
          // Now call translation with the spreadsheet ID and range
          google.script.run
            .withSuccessHandler(onTranslationSuccess)
            .withFailureHandler(onTranslationError)
            .translateSelection(targetLanguage, rangeInfo.spreadsheetId, rangeInfo.rangeA1);
        })
        .withFailureHandler(function(error) {
          setProgressVisible(false);
          setButtonsEnabled(true);
          showToast('Error getting range: ' + error.message, 'error');
        })
        .getSelectedRange();
    }
    
    /**
     * Success handler for translation
     */
    function onTranslationSuccess(result) {
      console.log('Translation completed:', result);
      
      // Reset UI
      setProgressVisible(false);
      setButtonsEnabled(true);
      
      if (result.success) {
        // Show success toast
        const message = `Successfully translated ${result.translatedCells} cells!`;
        showToast(message, 'success');
        
        // Show summary
        showSummaryCard(result);
        
      } else {
        // Show error
        showToast(result.error || result.message, 'error');
      }
    }
    
    /**
     * Failure handler for translation
     */
    function onTranslationError(error) {
      console.error('Translation error:', error);
      
      // Reset UI
      setProgressVisible(false);
      setButtonsEnabled(true);
      
      // Show error toast
      showToast('Translation failed: ' + error.message, 'error');
    }
    
    // ========================================================================
    // UNDO FUNCTIONALITY
    // ========================================================================
    
    /**
     * Undoes the last translation
     */
    function undoTranslation() {
      console.log('Undo initiated');
      
      // Confirm action
      if (!confirm('Are you sure you want to undo the last translation?')) {
        return;
      }
      
      // Update UI
      setButtonsEnabled(false);
      showToast('Undoing translation...', 'info', 3000);
      
      // Call backend
      google.script.run
        .withSuccessHandler(onUndoSuccess)
        .withFailureHandler(onUndoError)
        .undoLastTranslation();
    }
    
    /**
     * Success handler for undo
     */
    function onUndoSuccess(result) {
      console.log('Undo completed:', result);
      
      // Reset UI
      setButtonsEnabled(true);
      
      if (result.success) {
        // Show success toast
        const message = `Restored ${result.restoredCells} cells to their original values`;
        showToast(message, 'success');
        
        // Hide summary
        hideSummaryCard();
        
      } else {
        // Show error
        showToast(result.error || result.message, 'warning');
      }
    }
    
    /**
     * Failure handler for undo
     */
    function onUndoError(error) {
      console.error('Undo error:', error);
      
      // Reset UI
      setButtonsEnabled(true);
      
      // Show error toast
      showToast('Undo failed: ' + error.message, 'error');
    }
    
    // ========================================================================
    // TESTING FUNCTIONS (Optional)
    // ========================================================================
    
    /**
     * Test backend connection
     */
    function testBackendConnection() {
      console.log('Testing backend connection...');
      
      showToast('Testing connection...', 'info', 2000);
      
      google.script.run
        .withSuccessHandler(function(result) {
          console.log('Connection test:', result);
          if (result.success) {
            showToast(
              `Connected to: ${result.sheetName}`,
              'success'
            );
          } else {
            showToast(result.error, 'error');
          }
        })
        .withFailureHandler(function(error) {
          showToast('Connection error: ' + error.message, 'error');
        })
        .connectToSheet();
    }
  </script>
</body>
</html>